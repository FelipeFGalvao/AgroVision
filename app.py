# ==============================================================================
# app.py - Dashboard Interativo para o AgroVision com o streamlit
# ==============================================================================

import streamlit as st
import pandas as pd
import joblib
import numpy as np

# --- Configura√ß√£o da P√°gina ---
st.set_page_config(
    page_title="AgroVision - Previs√£o de Safras",
    page_icon="üåΩ",
    layout="wide"
)

# --- Fun√ß√µes de Carregamento de Dados (com cache) ---

@st.cache_resource
def carregar_modelo():
    """Carrega o modelo treinado do arquivo."""
    try:
        modelo = joblib.load('models/agrovision_random_forest_v1.joblib')
        return modelo
    except FileNotFoundError:
        return None

@st.cache_data
def carregar_dados_localizacao():
    """Carrega o ficheiro de localiza√ß√µes otimizado para um arranque r√°pido."""
    try:
        # Usando o ficheiro de localiza√ß√µes otimizado para a UI (levemente otimizado) 
        caminho_dados = 'data/processed/locations.parquet'
        df = pd.read_parquet(caminho_dados)
        df['display_name'] = df['municipio_nome'] + ' (' + df['uf'] + ')'
        return df
    except FileNotFoundError:
        return None

# --- Carregamento Inicial ---
modelo = carregar_modelo()
df_localizacoes = carregar_dados_localizacao()

# --- Interface do Usu√°rio (UI) ---
st.title("üåΩ AgroVision: Sistema de Previs√£o de Produtividade de Milho")
st.markdown("Selecione o munic√≠pio e insira os dados da safra para obter uma previs√£o de rendimento.")

# Verificar se os dados foram carregados
if df_localizacoes is None or modelo is None:
    st.error("ERRO: Arquivos de dados ('locations.parquet') ou do modelo n√£o foram encontrados. Execute os notebooks de prepara√ß√£o.")
else:
    col1, col2 = st.columns(2)

    with col1:
        st.subheader("üåç Sele√ß√£o do Munic√≠pio")
        
        lista_municipios = df_localizacoes['display_name'].tolist()
        municipio_selecionado = st.selectbox(
            "Selecione o munic√≠pio",
            options=lista_municipios
        )
        
        local_selecionado = df_localizacoes[df_localizacoes['display_name'] == municipio_selecionado].iloc[0]
        latitude = local_selecionado['latitude']
        longitude = local_selecionado['longitude']
        
        st.text_input("Latitude", value=f"{latitude:.4f}", disabled=True)
        st.text_input("Longitude", value=f"{longitude:.4f}", disabled=True)

    with col2:
        st.subheader("üóìÔ∏è Per√≠odo e Dados Ambientais")
        ano = st.slider("Ano da Safra para Previs√£o", min_value=2024, max_value=2030, value=2025)
        precipitacao = st.number_input("Precipita√ß√£o M√©dia Anual (mm/dia)", min_value=0.0, value=3.5, format="%.2f")
        temp_max = st.number_input("Temperatura M√°xima M√©dia Anual (¬∞C)", min_value=20.0, value=32.0, format="%.2f")
        temp_min = st.number_input("Temperatura M√≠nima M√©dia Anual (¬∞C)", min_value=-5.0, value=20.0, format="%.2f")
        ndvi = st.number_input(
            "NDVI M√°ximo da Safra", min_value=0.0, max_value=1.0, value=0.75, format="%.4f",
            help="√çndice de Vegeta√ß√£o por Diferen√ßa Normalizada - uma medida da sa√∫de da vegeta√ß√£o."
        )

    # Bot√£o para prever
    if st.button("üìä Gerar Previs√£o", use_container_width=True):
        # Criar um DataFrame com os dados de entrada
        dados_entrada = pd.DataFrame({
            'ano': [ano],
            'latitude': [latitude],
            'longitude': [longitude],
            'precipitacao_media_anual': [precipitacao],
            'temp_max_media_anual': [temp_max],
            'temp_min_media_anual': [temp_min],
            'ndvi_max_safra': [ndvi]
        })
        
        # Fazer a previs√£o
        previsao = modelo.predict(dados_entrada)
        
        # resultado
        st.success("### Previs√£o de Rendimento Gerada!")
        st.metric(
            label="Rendimento M√©dio Estimado",
            value=f"{previsao[0]:.2f} kg/ha",
            help="Esta √© a previs√£o da produtividade em quilogramas por hectare."
        )
